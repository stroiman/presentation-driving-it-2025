---
title: Building a Headless Browser in Go
info: |
  ## Slidev Starter Template
  Presentation slides for developers.

drawings:
  persist: true


---

# Building a Headless Browser in Go

---

# About me

- Coding since the age of 8
- Professional coder since 1997
- Passionate about Test-Driven Development
- Fine Arts Photographer

- [github.com/gost-dom](https://github.com/gost-dom)
- [github.com/stroiman](https://github.com/stroiman)
- [linkedin/in/stroiman](https://linkedin.com/in/stroiman)
- [stroiman.photography](https://stroiman.photography)

---

# Test-Driven Development

A way to increase developer efficiency, misunderstood even by many
practitioners.

## Working effecitvely with code

- Use short feedback cycles
- 
- The greater the uncertainty, the smaller the feedback loop

---

# It's not about unit tests

These are subjective opinions rooted in experience. 

- Don't single units in isolation; reflect the _behaviour_ of an application.
- Test units as a whole when they collaborate to 
  - Don't call a _Controller Method_
  - Send an HTTP request, verify the response, and side effects in the system.
- Only mock at layer boundaries

## The primary measure of the quality of a test suite

- Does it provide fast feedback?
- Does it enable safe refactoring?

---

# TDD and Web Applications

How to specify behaviour in the UI layer?

- 1990s, 2000s
  - Send HTTP request, and parse returned HTML
- 2010s - SPAs take over
  - Test UI and back-end separately
    - Behaviour is
      - Mapping HTTP requests to business rules
      - Mappint the outcome to HTTP responses
    - 
  - Test UI using tools like jsdom
  - Tools like redux allow application logic to be tested independently
- 2020s - Hypermedia applications
  - ???

---

# Hypermedia

- HTMX
- Datastar

---
src: ./htmx.md
---

# Verifying Behaviour?

Application behaviour becomes a choreography between

- HTML Elements with specific attributes defined
- The hypermedia framework parsing those attributes
- HTTP Response headers and body on generated responses
- Generated by handlers written for that framework

---

## Challenges

- Debugging

## Embedding V8 in Go

- v8go existed as a project
  - Not all v8 features were supported.

## Mistakes

- Using V8

---
src: ./pages/login-page.md
---

# Example

```go
func CreateRootHandler() *http.Handler {
}
```

```go
func TestIndexPage(t *testing.T) {
    browser := browser.New(
        browser.WithHandler(CreateRootHandler()),
        browser.WithContext(t.Context()), // Optional
    )
    window, err := browser.Open("https://example.com/")
    assert.NoError(t, err)
    title, err := window.Document().QuerySelector("h1")
    assert.True(t, error)
    assert.NotNil(t, title)
    assert.Equal(t, "Hello, World!", title.TextContent())
}
```

---

## Example: A session-based login page

Drive the implementation of _behaviour_ in the UI. 

- Security concerns
  - CSRF protection.
  - Encrypt session cookies

## Strategy

Mock the code validating credentials.

---

# Coupling to accessibility attributes

Shaman library 

```go
func TestIndexPage(t *testing.T) {

}
```

---

# Inspiration

- [Testing Library](https://testing-library.com/)
  - Writing tests coupled to accessibility 
- [jscom](https://github.com/jsdom/jsdom)
- Unmaintained
  - [Zombie](https://zombie.js.org/)
  - [PhantomJS](https://phantomjs.org/)
  - 
